-- Wait for game load
if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local PlaceId = game.PlaceId

-- This will pause the script for 5 minutes
task.wait(300)

local targetServer = nil
local maxPlayersFound = 0
local cursor = ""

for i = 1, 7 do
    -- Constructing the API URL with proper concatenation
    local url = "https://games.roblox.com/v1/games/" .. PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
    if cursor ~= "" then 
        url = url .. "&cursor=" .. cursor 
    end

    -- Safely get the server list
    local success, response = pcall(function()
        return HttpService:GetAsync(url)
    end)

    if not success then 
        task.wait(1) 
        continue 
    end

    local data = HttpService:JSONDecode(response)
    if not data or not data.data then break end

    for _, server in ipairs(data.data) do
        -- Ensure we aren't joining our current server or a full one
        if server.id ~= game.JobId and server.playing < server.maxPlayers then
            -- Logic to find the most populated available server
            if server.playing > maxPlayersFound then
                maxPlayersFound = server.playing
                targetServer = server
            end
        end
    end

    -- Update cursor for the next page of results
    cursor = data.nextPageCursor
    if not cursor or cursor == "" then break end
    task.wait(0.5)
end

-- Teleport the local player
if targetServer then
    TeleportService:TeleportToPlaceInstance(PlaceId, targetServer.id, Players.LocalPlayer)
else
    warn("Could not find a better server after 5 minutes.")
end
